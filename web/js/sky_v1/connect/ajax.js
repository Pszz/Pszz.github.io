sky.define("./connect/ajax",["./data/comm"],function(t,a){function e(t,a){var e="string"==typeof a?a:o.QS.stringify(a,"&");return e?t+(t.indexOf("?")>-1?"&":"?")+e:t}function c(t){t||(t={});var a=this.XHR=s(),c=sky.extra(this.uriParam,{});this.emit("open",t,c);var i=window.FormData&&t instanceof window.FormData,r=null;"string"==typeof t||i?r=t:t&&(r=o.QS.stringify(t,"&"));var n=e(this.url,c),l=sky.extra(this.header,{});if("GET"==this.method){r&&!i&&(n=e(n,r),r=null);var d=this.cache;d===!1&&(d="_r_="+(new Date).getTime()),"string"==typeof d&&(n=e(n,d)),a.open(this.method,n,this.async)}else a.open(this.method,n,this.async),i||(null==l["Content-Type"]&&(l["Content-Type"]="application/x-www-form-urlencoded"),r&&(r=r.replace(/[\x00-\x08\x11-\x12\x14-\x20]/g,"*")));this.emit("send",l),sky.forEach(l,function(t,e){a.setRequestHeader(e,t)}),this.async&&(a.onreadystatechange=this._requestChange);try{a.upload.onprogress=this._progress,a.onprogress=this._progressDown}catch(p){}return this.status=0,a.send(r),this}function i(t,a){this.emit("progress"+t,a)}function r(){var t=this.XHR;if(this.readyState=t.readyState,this.emit("requestchange"),4==t.readyState){if(!this.overFlag){this.responseHeaders=t.getAllResponseHeaders();try{this.responseText=t.responseText}catch(a){this.responseText=""}this.responseXML=t.responseXML?o.XML.parse(this.responseText):null,this.responseJSON=o.JSON.parse(this.responseText),this.status=t.status;var e=this.emit("complete");if(e!==!1){var c=this.emit("censor");this.error=c===!0?null:c,this.emit("callback"),this.emit(this.error?"fail":"success")}}return delete this.XHR,delete this.overFlag,null}return null}a.version="1.0.0";var s=window.XMLHttpRequest?function(){return new window.XMLHttpRequest}:function(){return new window.ActiveXObject("Microsoft.XMLHTTP")},o=t("./data/comm"),n=sky.bind,l=a.BaseClass=sky.extend(sky.EventEmitter,{oncensor:function(){var t=this.status;return t>=200&&300>t||304===t||1223===t?!0:"no data back,please try it later..."},abort:function(){return this.XHR&&this.XHR.abort(),this},send:function(t,a){if(this.XHR){if(4==this.XHR.readyState||!a)return this;this.overFlag=!0,this.XHR.abort(),this.XHR=null}return this.async?setTimeout(n(c,this,t)):c.call(this,t),this},getResponseHeader:function(t){return t?this.responseHeaders&&new RegExp("(?:"+t+"):[ 	]*([^\r\n]*)\r").test(this.responseHeaders)?RegExp.$1:"":this.responseHeaders||""},setRequestHeader:function(t,a){return this.header[t]=a,this},open:function(t,a,e){t&&(this.url=t),a&&(this.method=a),null!=e&&(this.async=!!e)}},function(){this.uriParam={},this.header={},this.url="",this.method="GET",this.async=!0,this._requestChange=n(r,this),this._progress=n(i,this,""),this._progressDown=n(i,this,"down"),arguments.length&&this.open.apply(this,arguments)});a.create=function(){var t=new l;return arguments.length&&t.open.apply(t,arguments),t},sky.forEach(["get","post","put","delete"],function(t){a[t]=function(a,e,c,i){return new l(a,t.toUpperCase(),!i).extra("oncallback",e).send(c)}})});